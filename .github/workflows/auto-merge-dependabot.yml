name: Auto Merge Dependabot (PR + Cron)

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  schedule:
    - cron: "*/30 * * * *"   # alle 30 Minuten pr√ºfen

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    steps:
      - name: Install GH CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Checkout repo
        uses: actions/checkout@v4

      # PR-EVENT-MODUS
      - name: Is a PR event?
        id: is_pr
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "pr_event=true" >> $GITHUB_OUTPUT
          else
            echo "pr_event=false" >> $GITHUB_OUTPUT
          fi

      - name: Handle PR event
        if: steps.is_pr.outputs.pr_event == 'true' && github.event.pull_request.user.login == 'dependabot[bot]'
        run: echo "Handling PR #${{ github.event.pull_request.number }} created by dependabot"

      - name: 'Comment - Auto-merge gestartet'
        if: steps.is_pr.outputs.pr_event == 'true' && github.event.pull_request.user.login == 'dependabot[bot]'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            üîÑ **Auto-Merge gestartet**
            - Warte auf Status-Checks
            - PR: #${{ github.event.pull_request.number }}
            - Initiator: Dependabot

      - name: Wait for all status checks
        if: steps.is_pr.outputs.pr_event == 'true' && github.event.pull_request.user.login == 'dependabot[bot]'
        uses: WyriHaximus/github-action-wait-for-status@v1
        with:
          ignoreActions: "documentation"

      - name: Merge PR (PR Event)
        if: steps.is_pr.outputs.pr_event == 'true' && github.event.pull_request.user.login == 'dependabot[bot]'
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --merge --admin
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment after merge
        if: steps.is_pr.outputs.pr_event == 'true' && github.event.pull_request.user.login == 'dependabot[bot]'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚úÖ **Auto-Merge erfolgreich abgeschlossen**
            - Merge-Commit erstellt
            - Alle Checks bestanden
            - Keine Konflikte

      # CRON-MODUS
      - name: 'Cron run - Find Dependabot PRs'
        if: steps.is_pr.outputs.pr_event == 'false'
        id: find_prs
        run: |
          gh pr list --search "author:dependabot state:open" --json number --jq "[].number" > prs.txt
          echo "Gefundene PRs:"
          cat prs.txt || echo "Keine PRs gefunden"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 'Cron run - Merge found PRs'
        if: steps.is_pr.outputs.pr_event == 'false'
        run: |
          while read pr; do
            echo "Versuche Auto-Merge f√ºr PR #$pr"
            gh pr merge "$pr" --merge --admin || echo "Konnte PR #$pr nicht mergen."
          done < prs.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
