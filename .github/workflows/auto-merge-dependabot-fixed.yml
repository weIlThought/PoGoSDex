name: Auto Merge Dependabot (PR + Cron)

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  schedule:
    - cron: '*/30 * * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install GH CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      # ==================================================
      # PR EVENT ‚Äì Dependabot + Label "dependencies"
      # ==================================================
      - name: Handle Dependabot PR (dependencies only)
        if: >
          github.event_name == 'pull_request' &&
          github.event.pull_request.user.login == 'dependabot[bot]' &&
          github.event.pull_request.draft == false &&
          contains(github.event.pull_request.labels.*.name, 'dependencies')
        run: |
          PR=${{ github.event.pull_request.number }}
          echo "Handling Dependabot PR #$PR (label: dependencies)"

          gh pr comment "$PR" --body "
          üîÑ **Auto-Merge gestartet**
          - Label: dependencies
          - GitHub pr√ºft automatisch alle Status-Checks
          - PR: #$PR
          "

          echo "Versuche Merge‚Ä¶"
          if gh pr merge "$PR" --merge --admin; then
            gh pr comment "$PR" --body "‚úÖ **Auto-Merge erfolgreich abgeschlossen**"
          else
            gh pr comment "$PR" --body "‚è≥ **Auto-Merge noch nicht m√∂glich**
            - Status-Checks laufen oder sind fehlgeschlagen
            - Wird beim n√§chsten Trigger erneut versucht"
          fi

      # ==================================================
      # CRON ‚Äì Retry f√ºr offene Dependabot PRs
      # ==================================================
      - name: Cron ‚Äì Auto-merge open Dependabot PRs (dependencies only)
        if: github.event_name == 'schedule'
        run: |
          echo "Suche offene Dependabot PRs mit Label 'dependencies'‚Ä¶"

          PRS=$(gh pr list \
            --search "author:dependabot state:open label:dependencies draft:false" \
            --json number \
            --jq '.[].number')

          if [ -z "$PRS" ]; then
            echo "Keine passenden PRs gefunden"
            exit 0
          fi

          for PR in $PRS; do
            echo "Bearbeite PR #$PR"

            gh pr comment "$PR" --body "
            üîÑ **Auto-Merge (Cron) gestartet**
            - Label: dependencies
            - GitHub pr√ºft automatisch alle Status-Checks
            "

            if gh pr merge "$PR" --merge --admin; then
              gh pr comment "$PR" --body "‚úÖ **Auto-Merge erfolgreich abgeschlossen**"
            else
              gh pr comment "$PR" --body "‚è≥ **Auto-Merge noch nicht m√∂glich**
              - Status-Checks laufen oder sind fehlgeschlagen
              - Wird automatisch erneut versucht"
            fi
          done
