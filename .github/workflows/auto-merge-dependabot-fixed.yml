name: Auto Merge Dependabot (PR + Cron)

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
  schedule:
    - cron: '*/30 * * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GH CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      # ===============================
      # PR EVENT (Dependabot)
      # ===============================
      - name: Handle Dependabot PR
        if: >
          github.event_name == 'pull_request' &&
          github.event.pull_request.user.login == 'dependabot[bot]'
        run: |
          PR=${{ github.event.pull_request.number }}
          echo "Handling Dependabot PR #$PR"

          gh pr comment "$PR" --body "
          üîÑ **Auto-Merge gestartet**
          - Warte auf Status-Checks
          - PR: #$PR
          "

          echo "Warte auf Status-Checks‚Ä¶"
          gh pr checks "$PR" --watch

          echo "Versuche Merge‚Ä¶"
          gh pr merge "$PR" --merge --admin \
            && gh pr comment "$PR" --body "‚úÖ **Auto-Merge erfolgreich abgeschlossen**" \
            || gh pr comment "$PR" --body "‚ùå **Auto-Merge fehlgeschlagen ‚Äì bitte manuell pr√ºfen**"

      # ===============================
      # CRON JOB
      # ===============================
      - name: Cron ‚Äì Auto-merge open Dependabot PRs
        if: github.event_name == 'schedule'
        run: |
          echo "Suche offene Dependabot PRs‚Ä¶"
          PRS=$(gh pr list --search "author:dependabot state:open" --json number --jq '.[].number')

          if [ -z "$PRS" ]; then
            echo "Keine PRs gefunden"
            exit 0
          fi

          for PR in $PRS; do
            echo "Bearbeite PR #$PR"

            gh pr comment "$PR" --body "
            üîÑ **Auto-Merge (Cron) gestartet**
            - Warte auf Status-Checks
            "

            gh pr checks "$PR" --watch

            gh pr merge "$PR" --merge --admin \
              && gh pr comment "$PR" --body "‚úÖ **Auto-Merge erfolgreich abgeschlossen**" \
              || gh pr comment "$PR" --body "‚ùå **Auto-Merge fehlgeschlagen ‚Äì bitte manuell pr√ºfen**"
          done
